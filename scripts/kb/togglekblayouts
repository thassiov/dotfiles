#!/usr/bin/env bash

# Universal Keyboard Layout Toggle
# Works in X11, Wayland, and TTY/Console

SCRIPT_DIRECTORY="$(dirname "$(readlink -f "$0")")"
CURRENT_LAYOUT=""
NEW_KB_LAYOUT=""

# Detect environment
detect_environment() {
    if [ -n "$WAYLAND_DISPLAY" ]; then
        echo "wayland"
    elif [ -n "$DISPLAY" ]; then
        echo "x11"
    else
        echo "tty"
    fi
}

# Get current layout based on environment
get_current_layout() {
    local env=$(detect_environment)

    case "$env" in
        x11)
            # X11: use setxkbmap
            setxkbmap -print | awk -F"+" '/xkb_symbols/ {print $2}'
            ;;
        tty)
            # TTY: check a state file since we can't query loadkeys easily
            if [ -f /tmp/current_kb_layout ]; then
                cat /tmp/current_kb_layout
            else
                echo "us"  # default
            fi
            ;;
        wayland)
            # Wayland: compositor-specific, defaulting to state file
            if [ -f /tmp/current_kb_layout ]; then
                cat /tmp/current_kb_layout
            else
                echo "us"  # default
            fi
            ;;
    esac
}

# Set keyboard layout based on environment
set_layout() {
    local layout="$1"
    local env=$(detect_environment)

    case "$env" in
        x11)
            # X11: use existing scripts
            if [ "$layout" == "us" ]; then
                NEW_KB_LAYOUT="US-DEV"
                echo "Setting us-dev keyboard layout"
                "$SCRIPT_DIRECTORY/useuskb"
            else
                NEW_KB_LAYOUT="BR-DEV"
                echo "Setting abnt2-dev keyboard layout"
                "$SCRIPT_DIRECTORY/useabntkb"
            fi

            # Handle Caps Lock if it's on
            if [[ $(xset -q 2>/dev/null) =~ (Caps Lock: *on) ]]; then
                xdotool key Caps_Lock 2>/dev/null
            fi

            # Send notification
            notify-send "Changed keyboard layout" "Now using $NEW_KB_LAYOUT" \
                --icon="$SCRIPT_DIRECTORY/keyboard.png" 2>/dev/null
            ;;

        tty)
            # TTY: use loadkeys with console keymaps
            if [ "$layout" == "us" ]; then
                NEW_KB_LAYOUT="US-DEV"
                echo "Setting us-dev keyboard layout (TTY)"
                sudo loadkeys "$SCRIPT_DIRECTORY/keymaps/console/us-dev.map"
            else
                NEW_KB_LAYOUT="BR-DEV"
                echo "Setting br-dev keyboard layout (TTY)"
                sudo loadkeys "$SCRIPT_DIRECTORY/keymaps/console/br-dev.map"
            fi

            # Save state
            echo "$layout" > /tmp/current_kb_layout
            echo "Changed keyboard layout to $NEW_KB_LAYOUT"
            ;;

        wayland)
            # Wayland: compositor-specific (add support as needed)
            echo "Wayland support not yet implemented"
            echo "Please configure keyboard layout in your compositor settings"
            ;;
    esac
}

# Main toggle logic
CURRENT_LAYOUT=$(get_current_layout)

if [ "$CURRENT_LAYOUT" == "us" ]; then
    set_layout "br"
elif [ "$CURRENT_LAYOUT" == "br" ]; then
    set_layout "us"
else
    # Default to US if unknown
    set_layout "us"
fi
